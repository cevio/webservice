require('./cssclass');
var animationEnd = require('animationend');
module.exports = appAnimate;

var animArr = [
    "pt-page-moveToLeft,pt-page-moveFromRight",
    "pt-page-moveToRight,pt-page-moveFromLeft",
    "pt-page-moveToTop,pt-page-moveFromBottom",
    "pt-page-moveToBottom,pt-page-moveFromTop",
    "pt-page-fade,pt-page-moveFromRight pt-page-ontop",
    "pt-page-fade,pt-page-moveFromLeft pt-page-ontop",
    "pt-page-fade,pt-page-moveFromBottom pt-page-ontop",
    "pt-page-fade,pt-page-moveFromTop pt-page-ontop",
    "pt-page-moveToLeftFade,pt-page-moveFromRightFade",
    "pt-page-moveToRightFade,pt-page-moveFromLeftFade",
    "pt-page-moveToTopFade,pt-page-moveFromBottomFade",
    "pt-page-moveToBottomFade,pt-page-moveFromTopFade",
    "pt-page-moveToLeftEasing pt-page-ontop,pt-page-moveFromRight",
    "pt-page-moveToRightEasing pt-page-ontop,pt-page-moveFromLeft",
    "pt-page-moveToTopEasing pt-page-ontop,pt-page-moveFromBottom",
    "pt-page-moveToBottomEasing pt-page-ontop,pt-page-moveFromTop",
    "pt-page-scaleDown,pt-page-moveFromRight pt-page-ontop",
    "pt-page-scaleDown,pt-page-moveFromLeft pt-page-ontop",
    "pt-page-scaleDown,pt-page-moveFromBottom pt-page-ontop",
    "pt-page-scaleDown,pt-page-moveFromTop pt-page-ontop",
    "pt-page-scaleDown,pt-page-scaleUpDown pt-page-delay300",
    "pt-page-scaleDownUp,pt-page-scaleUp pt-page-delay300",
    "pt-page-moveToLeft pt-page-ontop,pt-page-scaleUp",
    "pt-page-moveToRight pt-page-ontop,pt-page-scaleUp",
    "pt-page-moveToTop pt-page-ontop,pt-page-scaleUp",
    "pt-page-moveToBottom pt-page-ontop,pt-page-scaleUp",
    "pt-page-scaleDownCenter,pt-page-scaleUpCenter pt-page-delay400",
    "pt-page-rotateRightSideFirst,pt-page-moveFromRight pt-page-delay200 pt-page-ontop",
    "pt-page-rotateLeftSideFirst,pt-page-moveFromLeft pt-page-delay200 pt-page-ontop",
    "pt-page-rotateTopSideFirst,pt-page-moveFromTop pt-page-delay200 pt-page-ontop",
    "pt-page-rotateBottomSideFirst,pt-page-moveFromBottom pt-page-delay200 pt-page-ontop",
    "pt-page-flipOutRight,pt-page-flipInLeft pt-page-delay500",
    "pt-page-flipOutLeft,pt-page-flipInRight pt-page-delay500",
    "pt-page-flipOutTop,pt-page-flipInBottom pt-page-delay500",
    "pt-page-flipOutBottom,pt-page-flipInTop pt-page-delay500",
    "pt-page-rotateFall pt-page-ontop,pt-page-scaleUp",
    "pt-page-rotateOutNewspaper,pt-page-rotateInNewspaper pt-page-delay500",
    "pt-page-rotatePushLeft,pt-page-moveFromRight",
    "pt-page-rotatePushRight,pt-page-moveFromLeft",
    "pt-page-rotatePushTop,pt-page-moveFromBottom",
    "pt-page-rotatePushBottom,pt-page-moveFromTop",
    "pt-page-rotatePushLeft,pt-page-rotatePullRight pt-page-delay180",
    "pt-page-rotatePushRight,pt-page-rotatePullLeft pt-page-delay180",
    "pt-page-rotatePushTop,pt-page-rotatePullBottom pt-page-delay180",
    "pt-page-rotatePushBottom,pt-page-rotatePullTop pt-page-delay180",
    "pt-page-rotateFoldLeft,pt-page-moveFromRightFade",
    "pt-page-rotateFoldRight,pt-page-moveFromLeftFade",
    "pt-page-rotateFoldTop,pt-page-moveFromBottomFade",
    "pt-page-rotateFoldBottom,pt-page-moveFromTopFade",
    "pt-page-moveToRightFade,pt-page-rotateUnfoldLeft",
    "pt-page-moveToLeftFade,pt-page-rotateUnfoldRight",
    "pt-page-moveToBottomFade,pt-page-rotateUnfoldTop",
    "pt-page-moveToTopFade,pt-page-rotateUnfoldBottom",
    "pt-page-rotateRoomLeftOut pt-page-ontop,pt-page-rotateRoomLeftIn",
    "pt-page-rotateRoomRightOut pt-page-ontop,pt-page-rotateRoomRightIn",
    "pt-page-rotateRoomTopOut pt-page-ontop,pt-page-rotateRoomTopIn",
    "pt-page-rotateRoomBottomOut pt-page-ontop,pt-page-rotateRoomBottomIn",
    "pt-page-rotateCubeLeftOut pt-page-ontop,pt-page-rotateCubeLeftIn",
    "pt-page-rotateCubeRightOut pt-page-ontop,pt-page-rotateCubeRightIn",
    "pt-page-rotateCubeTopOut pt-page-ontop,pt-page-rotateCubeTopIn",
    "pt-page-rotateCubeBottomOut pt-page-ontop,pt-page-rotateCubeBottomIn",
    "pt-page-rotateCarouselLeftOut pt-page-ontop,pt-page-rotateCarouselLeftIn",
    "pt-page-rotateCarouselRightOut pt-page-ontop,pt-page-rotateCarouselRightIn",
    "pt-page-rotateCarouselTopOut pt-page-ontop,pt-page-rotateCarouselTopIn",
    "pt-page-rotateCarouselBottomOut pt-page-ontop,pt-page-rotateCarouselBottomIn",
    "pt-page-rotateSidesOut,pt-page-rotateSidesIn pt-page-delay200",
    "pt-page-rotateSlideOut,pt-page-rotateSlideIn"
];

function appAnimate(ANIMATEIN, ANIMATEOUT){
    return function(browser){
        appAnimate.init(browser);
        appAnimate.goahead(browser, ANIMATEIN);
        appAnimate.retreat(browser, ANIMATEOUT);
        appAnimate.quiescence(browser);
    };
}

appAnimate.animating = false;
appAnimate.init = function(browser){
    var views = browser.views;
    var keys = Object.keys(views);
    if ( !keys.length ){
        throw new Error('no webview, please add webview on page.');
    }
    var el = browser.views[keys[0]].wraproot, parent, i = keys.length;
    if ( el === document.body ){ parent = document.body; }
    else{ parent = el.parentNode; }
    parent.addClass('pt-perspective');
    while(i--){
        views[keys[i]].wraproot.addClass('pt-page');
    }
};

appAnimate.goahead = function(browser, ANIMATE){
    var animate = appAnimate.which(ANIMATE);
    browser.on('goahead', function(){
        if ( appAnimate.animating ) return;
        appAnimate.animating = true;
        headGoAhead(browser);
        var current = browser.current;
        var target = browser.target;
        animationEnd(target.wraproot).then(function(event){
            current && current.wraproot.setAttribute('class', 'pt-page webview');
            target.wraproot.setAttribute('class', 'pt-page webview pt-page-current');
            var root = browser._headbar.wraproot;
            var c = root.querySelector('.copier');
            if ( c ){
                root.removeChild(c);
            }
            browser.exchange();
            appAnimate.animating = false;
        });
        if ( current ){
            current.wraproot.setAttribute('class', 'pt-page webview ' + animate[0] + ' page-show');
        }
        if ( target ){
            target.wraproot.setAttribute('class', 'pt-page webview pt-page-current ' + animate[1]);
        }
    });
};

appAnimate.retreat = function(browser, ANIMATE){
    var animate = appAnimate.which(ANIMATE);
    browser.on('retreat', function(){
        if ( appAnimate.animating ) return;
        appAnimate.animating = true;
        headReTreat(browser);
        var current = browser.current;
        var target = browser.target;
        animationEnd(target.wraproot).then(function(event){
            current && current.wraproot.setAttribute('class', 'pt-page webview');
            target.wraproot.setAttribute('class', 'pt-page webview pt-page-current');
            var root = browser._headbar.wraproot;
            var c = root.querySelector('.copier');
            if ( c ){
                root.removeChild(c);
            }
            browser.exchange();
            appAnimate.animating = false;
        });
        if ( current ){
            current.wraproot.setAttribute('class', 'pt-page webview ' + animate[0] + ' page-show');
        }
        if ( target ){
            target.wraproot.setAttribute('class', 'pt-page webview pt-page-current ' + animate[1]);
        }
    });
};

appAnimate.quiescence = function(browser){
    browser.on('quiescence', function(){
        if ( browser.current ){
            browser.data.header.page = browser.current.wrapname;
        }
        browser.exchange();
    });
};

appAnimate.which = function(ANIMATE){
    return animArr[ANIMATE].split(',');
};

function headGoAhead(browser){
    if ( browser.animate && !browser.data.header.hide ){
        var root = browser._headbar.wraproot;
        var c = root.querySelector('.copier');
        if ( c ){
            c.parentNode.removeChild(c);
        }
        var inner = browser._headbar.wrapinner;
        var copier = inner.cloneNode(true);
        root.appendChild(copier);
        copier.addClass('copier');

        var a = inner.querySelector('.webview-header-inner');
        var b = copier;

        b.addClass('header-out-slide');
        a.addClass('header-in-slide');

        if ( browser.target ){
            browser.data.header.page = browser.target.wrapname;
        }

        setTimeout(function(){
            animationEnd(b).then(function(event){
                a.setAttribute('class', 'webview-header-inner');
            });
            b.addClass('header-slide header-out-slide-goahead');
            a.addClass('header-slide header-in-slide-goahead');
        }, 0);
    }
}

function headReTreat(browser){
    if ( browser.animate && !browser.data.header.hide ){
        var root = browser._headbar.wraproot;
        var inner = browser._headbar.wrapinner;
        var copier = inner.cloneNode(true);
        root.insertBefore(copier, inner);
        copier.addClass('copier');
        var a = inner;
        var b = copier.querySelector('.webview-header-inner');

        b.addClass('header-back-out');
        a.addClass('header-back-in');

        if ( browser.target ){
            browser.data.header.page = browser.target.wrapname;
        }

        setTimeout(function(){
            animationEnd(b).then(function(event){
                a.setAttribute('class', 'webview-header-outer');
            });
            b.addClass('header-slide header-back-out-slide');
            a.addClass('header-slide header-back-in-slide');
        }, 0);
    }
}