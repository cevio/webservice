/**
 * Created by evio on 15/8/26.
 */
var chars = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];

var jsonp = module.exports = function(url, callback, name){
    if ( !name ) name = 'callback';
    var ints = url.indexOf('?');
    var left = '', right = '';
    var jsonpname = 'jsonp_' + new Date().getTime() + '_' + generateMixed(10);
    var jsonpData = null;

    if ( ints > -1 ){
        right = url.substring(ints);
        left = url.substring(0, ints);
        if ( right === '?' ){
            url = left + '?' + name + '=' + jsonpname;
        }else{
            url = left + right + '&' + name + '=' + jsonpname;
        }
    }else{
        url = url + '?' + name + '=' + jsonpname;
    }

    window[jsonpname] = function(data){
        jsonpData = data;
    };

    jsonp.script(url, function(){
        setTimeout(function(){ typeof callback === 'function' && callback(jsonpData); }, 0);
    });
};

jsonp.script = function(url, callback){
    var node = document.createElement('script');
    var doc = window.document;
    var head = doc.head || doc.getElementsByTagName("head")[0] || doc.documentElement;
    var baseElement = head.getElementsByTagName("base")[0];
    node.onload =
        node.onreadystatechange =
            function() {
                if (
                    !this.readyState ||
                    this.readyState === "loaded" ||
                    this.readyState === "complete"
                ){
                    node.onreadystatechange = null;
                    typeof callback === 'function' && callback.call(this);
                }
            };
    node.async = true;
    node.src = url;
    baseElement ?
        head.insertBefore(node, baseElement) :
        head.appendChild(node);
};

function generateMixed(n) {
    var res = "";
    for(var i = 0; i < n ; i ++) {
        var id = Math.ceil(Math.random()*35);
        res += chars[id];
    }
    return res;
}